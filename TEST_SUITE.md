# Complete Test Suite - Logging Implementation Verification

## Overview
This test suite verifies that all logging features work correctly in the LoggingProduction API.

---

## Test 1: Verify Startup Logging with Enrichment

### What to Check:
When you start the app, you should see in the console:

```
[HH:MM:SS INF] Starting application {
  "Application": "LoggingProduction",
  "Environment": "Development",
  "EnvironmentUserName": "DESKTOP-XXXX\\username",
  "MachineName": "DESKTOP-XXXX",
  "ThreadId": 2
}
```

### Verification Checklist:
- [ ] Application name appears (enrichment works)
- [ ] Environment shows "Development" (WithEnvironmentName works)
- [ ] EnvironmentUserName shows your user (WithEnvironmentUserName works)
- [ ] MachineName shows your machine (WithMachineName works)
- [ ] ThreadId is present (WithThreadId works)

### Status: ✅ PASS if you see all above fields

---

## Test 2: Create Order with Client Correlation ID

### PowerShell Command:
```powershell
$body = @{
    customerId = "cust-456"
    total = 99.99
} | ConvertTo-Json

Invoke-RestMethod -Method Post `
    -Uri "https://localhost:7002/api/orders" `
    -ContentType "application/json" `
    -Headers @{"X-Correlation-Id" = "test-123"} `
    -Body $body `
    -SkipCertificateCheck
```

### Expected Response:
```json
{
  "id": "06537730-f786-4291-9b06-40b1d542d75c",
  "customerId": "cust-456",
  "total": 99.99,
  "status": 0,
  "createdAt": "2025-11-28T16:48:32.0719929Z"
}
```

### Console Log Should Show:
```
[HH:MM:SS INF] HTTP POST /api/orders responded 201 in XXms {"CorrelationId":"test-123","ClientIP":"127.0.0.1","UserAgent":"...","RequestHost":"localhost:7002",...}
[HH:MM:SS INF] Creating order for customer cust-456 with total 99.99 {"CorrelationId":"test-123","SourceContext":"LoggingProduction.Services.OrderService",...}
[HH:MM:SS INF] Order 06537730-f786-4291-9b06-40b1d542d75c created successfully with status Pending {"CorrelationId":"test-123",...}
```

### Verification Checklist:
- [ ] Response returns 201 Created
- [ ] Response has order ID
- [ ] Logs show "CorrelationId":"test-123" (your custom ID is used)
- [ ] Logs show customer and total as structured properties
- [ ] Multiple logs all have same correlation ID

### Status: ✅ PASS if correlation ID appears in all logs

---

## Test 3: Auto-Generated Correlation ID

### PowerShell Command:
```powershell
$response = Invoke-WebRequest -Method Get `
    -Uri "https://localhost:7002/api/orders" `
    -SkipCertificateCheck -PassThru

# Check response headers
$response.Headers["X-Correlation-Id"]
```

### Expected Response Headers:
```
X-Correlation-Id: <auto-generated-guid>
```

### Console Log Should Show:
```
[HH:MM:SS INF] HTTP GET /api/orders responded 200 in XXms {"CorrelationId":"<auto-generated-guid>","ClientIP":"127.0.0.1",...}
[HH:MM:SS INF] Retrieving all orders {"CorrelationId":"<auto-generated-guid>",...}
```

### Verification Checklist:
- [ ] Response header contains X-Correlation-Id
- [ ] ID is a GUID (auto-generated)
- [ ] Logs show the same auto-generated ID
- [ ] ID is different from test-123 (new request = new ID)

### Status: ✅ PASS if auto-generated ID appears

---

## Test 4: Health Check Filtering (No Spam)

### PowerShell Command:
```powershell
Invoke-RestMethod -Method Get `
    -Uri "https://localhost:7002/health" `
    -SkipCertificateCheck
```

### Expected Response:
```json
{
  "status": "Healthy"
}
```

### Console Log Should Show:
```
(Nothing - health check logs are at VERBOSE level, filtered out)
```

### Verification Checklist:
- [ ] Request succeeds (200 OK)
- [ ] No log output appears in console (VERBOSE level filtered)
- [ ] But check log file - should contain VERBOSE level entry

### Status: ✅ PASS if health check doesn't spam logs

---

## Test 5: Error Handling (404 Not Found)

### PowerShell Command:
```powershell
Invoke-RestMethod -Method Get `
    -Uri "https://localhost:7002/api/orders/non-existent" `
    -SkipCertificateCheck `
    -ErrorAction SilentlyContinue
```

### Expected Response:
```json
{
  "message": "Order not found"
}
```

### Console Log Should Show (at WARNING level):
```
[HH:MM:SS WRN] HTTP GET /api/orders/non-existent responded 404 in XXms {"CorrelationId":"<id>","ClientIP":"127.0.0.1",...}
[HH:MM:SS WRN] Order non-existent not found {"CorrelationId":"<id>",...}
```

### Verification Checklist:
- [ ] Response status is 404
- [ ] Log level is WRN (not INF) - automatic based on status code!
- [ ] Correlation ID appears
- [ ] Logs show the not-found condition

### Status: ✅ PASS if error automatically elevated to WARNING

---

## Test 6: Multiple Concurrent Requests (Different IDs)

### PowerShell Commands (Run in parallel in separate terminals):
```powershell
# Terminal 1
Invoke-RestMethod -Method Get `
    -Uri "https://localhost:7002/api/orders" `
    -SkipCertificateCheck

# Terminal 2
Invoke-RestMethod -Method Get `
    -Uri "https://localhost:7002/api/products" `
    -SkipCertificateCheck

# Terminal 3
Invoke-RestMethod -Method Get `
    -Uri "https://localhost:7002/api/orders/search?customerId=test" `
    -SkipCertificateCheck
```

### Console Log Should Show:
```
[HH:MM:SS INF] HTTP GET /api/orders responded 200 in XXms {"CorrelationId":"id-1111",...}
[HH:MM:SS INF] HTTP GET /api/products responded 200 in XXms {"CorrelationId":"id-2222",...}
[HH:MM:SS INF] HTTP GET /api/orders/search responded 200 in XXms {"CorrelationId":"id-3333",...}
```

### Verification Checklist:
- [ ] Each request gets a different correlation ID
- [ ] No ID is reused
- [ ] Logs from different requests are distinguishable
- [ ] All responses return 200

### Status: ✅ PASS if each request has unique ID

---

## Test 7: Correlation ID Propagation (Client Provides ID)

### PowerShell Command:
```powershell
$response = Invoke-WebRequest -Method Post `
    -Uri "https://localhost:7002/api/orders" `
    -ContentType "application/json" `
    -Headers @{"X-Correlation-Id" = "my-custom-id-999"} `
    -Body '{"customerId":"cust-777","total":49.99}' `
    -SkipCertificateCheck `
    -PassThru

# Check that response contains the correlation ID
Write-Host "Response Header X-Correlation-Id: $($response.Headers['X-Correlation-Id'])"
```

### Expected Response Headers:
```
X-Correlation-Id: my-custom-id-999
```

### Console Log Should Show:
```
[HH:MM:SS INF] HTTP POST /api/orders responded 201 in XXms {"CorrelationId":"my-custom-id-999",...}
[HH:MM:SS INF] Creating order for customer cust-777 with total 49.99 {"CorrelationId":"my-custom-id-999",...}
```

### Verification Checklist:
- [ ] Client-provided ID is accepted
- [ ] Response header returns same ID
- [ ] All logs use the client-provided ID
- [ ] Not overwritten with a new GUID

### Status: ✅ PASS if client ID is propagated

---

## Test 8: Verify Log Files

### Command:
```powershell
# List log files
Get-ChildItem C:\Users\<username>\Desktop\code\.NET_API_Logging\src\LoggingProduction\logs\

# Read latest log file
Get-Content "logs\log-2025-11-28.txt" -Tail 50
```

### Expected Output:
```
2025-11-28 22:23:40.000 +00:00 [INF] Starting application {"Application":"LoggingProduction",...}
2025-11-28 22:24:15.123 +00:00 [INF] HTTP POST /api/orders responded 201 in 45ms {"CorrelationId":"test-123",...}
2025-11-28 22:24:15.124 +00:00 [INF] Creating order for customer cust-456 with total 99.99 {"CorrelationId":"test-123",...}
```

### Verification Checklist:
- [ ] Log files exist in logs/ directory
- [ ] File named log-YYYY-MM-DD.txt (daily rolling)
- [ ] Logs contain full timestamps
- [ ] All properties in JSON format
- [ ] Can grep by correlation ID: `Select-String "test-123" logs\*.txt`

### Status: ✅ PASS if log files contain structured data

---

## Test 9: Structured Data Search

### Command:
```powershell
# Find all logs for a specific customer
Select-String "cust-456" logs\log-*.txt

# Find all logs by correlation ID
Select-String "test-123" logs\log-*.txt

# Find all errors
Select-String "\[ERR\]" logs\log-*.txt
```

### Expected Output:
```
logs/log-2025-11-28.txt:[INF] HTTP POST /api/orders responded 201 in 45ms {"CorrelationId":"test-123","CustomerID":"cust-456",...}
logs/log-2025-11-28.txt:[INF] Creating order for customer cust-456 with total 99.99 {"CorrelationId":"test-123",...}
```

### Verification Checklist:
- [ ] Can search log files by customer ID
- [ ] Can search by correlation ID
- [ ] Can search by log level
- [ ] Structured format allows filtering

### Status: ✅ PASS if logs are queryable

---

## Test 10: Response Timing

### PowerShell Command:
```powershell
# Measure response time
$start = Get-Date
$response = Invoke-RestMethod -Method Get `
    -Uri "https://localhost:7002/api/orders" `
    -SkipCertificateCheck
$elapsed = (Get-Date) - $start

Write-Host "Request took: $($elapsed.TotalMilliseconds) ms"
```

### Console Log Should Show:
```
[HH:MM:SS INF] HTTP GET /api/orders responded 200 in 12ms {...}
```

### Verification Checklist:
- [ ] Log shows response time in milliseconds
- [ ] Time matches approximate request duration
- [ ] All requests show timing

### Status: ✅ PASS if timing is logged

---

## Summary Table

| Test | Feature | Pass/Fail |
|------|---------|-----------|
| 1 | Startup Enrichment | ✅ |
| 2 | Client Correlation ID | ✅ |
| 3 | Auto-Generated ID | ✅ |
| 4 | Health Check Filtering | ✅ |
| 5 | Error Logging (404) | ✅ |
| 6 | Concurrent Requests | ✅ |
| 7 | ID Propagation | ✅ |
| 8 | Log Files | ✅ |
| 9 | Structured Search | ✅ |
| 10 | Response Timing | ✅ |

---

## Final Verification

If ALL 10 tests pass, your logging implementation is **100% working**:

✅ Serilog configured correctly
✅ Correlation IDs generated and propagated
✅ Enrichment working (machine, environment, user, thread)
✅ Smart filtering working (health checks hidden, errors elevated)
✅ Async sinks working (non-blocking)
✅ Rolling file logs working
✅ Structured logging working
✅ All logs queryable by correlation ID

---

## Quick Troubleshooting

### Logs not appearing in console?
- Check log level in appsettings.json
- Verify `WriteTo.Async(a => a.Console(...))` in Program.cs

### Correlation ID not in logs?
- Verify `LogContext.PushProperty("CorrelationId", correlationId)` in middleware
- Check that middleware is registered: `app.UseMiddleware<CorrelationIdMiddleware>();`

### Response headers missing X-Correlation-Id?
- Verify `context.Response.OnStarting()` is called
- Check for middleware ordering (CorrelationId must come before other middleware)

### Health checks still appearing in logs?
- Verify `GetLevel` filtering in RequestLoggingExtensions
- Check MinimumLevel in appsettings.json

---

## Success Criteria

✅ **You have a working logging system** if:
1. Startup logs show enrichment (Application, Environment, MachineName)
2. Every request has a correlation ID (auto-generated or client-provided)
3. Correlation ID appears in ALL logs for that request
4. Response headers include X-Correlation-Id
5. Health checks don't appear in logs (filtered to VERBOSE)
6. Errors are flagged as WARNING or ERROR
7. Log files are created daily with rolling retention
8. All logs are JSON-structured and queryable
